// –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Ü–∏—Ñ—Ä

const fs = require('fs');
const path = require('path');
const https = require('https');

// –ü—Ä–æ—Å—Ç–∞—è —Å–∏–≥–º–æ–∏–¥–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
const sigmoid = (x) => {
  x = Math.max(-10, Math.min(10, x));
  return 1 / (1 + Math.exp(-x));
};

// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
const downloadImage = (url, filename) => {
  return new Promise((resolve, reject) => {
    const file = fs.createWriteStream(filename);
    https.get(url, (response) => {
      response.pipe(file);
      file.on('finish', () => {
        file.close();
        resolve(filename);
      });
    }).on('error', (err) => {
      fs.unlink(filename, () => {}); // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –ø—Ä–∏ –æ—à–∏–±–∫–µ
      reject(err);
    });
  });
};

// –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
// –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º ASCII-–∞—Ä—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
const createDigitPatterns = () => {
  const patterns = {};
  
  // –ü—Ä–æ—Å—Ç—ã–µ ASCII-–ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ü–∏—Ñ—Ä (30x30)
  const digitPatterns = {
    0: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    1: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    2: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    3: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    4: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    5: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    6: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    7: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    8: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `,
    9: `
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
      ##############################
    `
  };
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º ASCII-–ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –ø–∏–∫—Å–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  for (let digit = 0; digit <= 9; digit++) {
    const pattern = digitPatterns[digit];
    const lines = pattern.trim().split('\n');
    const pixels = [];
    
    for (const line of lines) {
      for (let i = 0; i < line.length; i++) {
        pixels.push(line[i] === '#' ? 1 : 0);
      }
    }
    
    patterns[digit] = pixels;
  }
  
  return patterns;
};

// –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
const trainNetwork = (patterns, canvasSize = 30) => {
  const totalPixels = canvasSize * canvasSize;
  const weights = {};
  const biases = {};
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ—Å–æ–≤
  for (let digit = 0; digit <= 9; digit++) {
    weights[digit] = new Array(totalPixels).fill(0).map(() => (Math.random() - 0.5) * 0.01);
    biases[digit] = (Math.random() - 0.5) * 0.01;
  }
  
  const learningRate = 0.01;
  const epochs = 3; // –ë—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ
  
  console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö...');
  console.log(`üìä –†–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞: ${canvasSize}x${canvasSize}`);
  console.log(`üìà –≠–ø–æ—Ö –æ–±—É—á–µ–Ω–∏—è: ${epochs}`);
  
  for (let epoch = 0; epoch < epochs; epoch++) {
    let totalError = 0;
    
    for (let digit = 0; digit <= 9; digit++) {
      const pattern = patterns[digit];
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–∞ –¥–ª—è –≤—Å–µ—Ö —Ü–∏—Ñ—Ä
      for (let d = 0; d <= 9; d++) {
        let sum = biases[d];
        for (let i = 0; i < totalPixels; i++) {
          sum += pattern[i] * weights[d][i];
        }
        
        const prediction = sigmoid(sum);
        const target = d === digit ? 1 : 0;
        const error = target - prediction;
        totalError += Math.abs(error);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å–∞
        biases[d] += learningRate * error;
        for (let i = 0; i < totalPixels; i++) {
          weights[d][i] += learningRate * error * pattern[i];
        }
      }
    }
    
    console.log(`–≠–ø–æ—Ö–∞ ${epoch + 1}/${epochs}, –û—à–∏–±–∫–∞: ${totalError.toFixed(4)}`);
  }
  
  return { weights, biases };
};

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
const main = async () => {
  console.log('üéØ –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ü–∏—Ñ—Ä...');
  
  try {
    // –°–æ–∑–¥–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ü–∏—Ñ—Ä
    const patterns = createDigitPatterns();
    console.log('‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Ü–∏—Ñ—Ä —Å–æ–∑–¥–∞–Ω—ã');
    
    // –û–±—É—á–∞–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç—å
    const { weights, biases } = trainNetwork(patterns, 30);
    console.log('‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–µ–ª—å
    const model = {
      weights: {},
      biases: {},
      metadata: {
        version: "1.0",
        created: new Date().toISOString().split('T')[0],
        canvasSize: 30,
        totalPixels: 900,
        description: "–ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Ü–∏—Ñ—Ä",
        trainingEpochs: 3,
        learningRate: 0.01,
        trainingExamples: 10
      }
    };
    
    // –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å–∞ –∏ —Å–º–µ—â–µ–Ω–∏—è
    for (let digit = 0; digit <= 9; digit++) {
      model.weights[digit.toString()] = weights[digit];
      model.biases[digit.toString()] = biases[digit];
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–ø–∫—É public/models —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const modelName = `image-model-${timestamp}`;
    const modelPath = path.join(__dirname, 'public', 'models', `${modelName}.json`);
    
    fs.writeFileSync(modelPath, JSON.stringify(model, null, 2));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
    const modelsListPath = path.join(__dirname, 'public', 'models', 'models.json');
    let modelsList = { models: [] };
    
    if (fs.existsSync(modelsListPath)) {
      try {
        const content = fs.readFileSync(modelsListPath, 'utf8');
        modelsList = JSON.parse(content);
      } catch (error) {
        console.log('–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π');
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –º–æ–¥–µ–ª—å –≤ —Å–ø–∏—Å–æ–∫
    modelsList.models.push({
      name: modelName,
      type: 'image-based',
      description: model.metadata.description
    });
    
    fs.writeFileSync(modelsListPath, JSON.stringify(modelsList, null, 2));
    
    console.log('‚úÖ –ú–æ–¥–µ–ª—å –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
    console.log(`üìä –†–∞–∑–º–µ—Ä: ${Object.keys(model.weights).length} —Ü–∏—Ñ—Ä √ó ${model.weights[0].length} –ø–∏–∫—Å–µ–ª–µ–π`);
    console.log(`üìÅ –§–∞–π–ª: ${modelPath}`);
    console.log(`üè∑Ô∏è  –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏: ${modelName}`);
    console.log(`üìã –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω`);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
  }
};

// –ó–∞–ø—É—Å–∫
main();
